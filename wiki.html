<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiki – SchulSystem</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Minimal ergänzendes Styling für das Wiki-Layout */
    :root{
      --primary:#2c3e50;
      --accent:#3498db;
      --card:#ffffff;
      --bg:#f4f6f9;
      --muted:#6b7280;
    }
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#222;}
    header{background:var(--primary); color:white; padding:1.25rem; display:flex; align-items:center; gap:1rem; justify-content:space-between;}
    header h1{margin:0; font-size:1.2rem;}
    .container{display:flex; max-width:1150px; margin:1.5rem auto; gap:1rem; padding:0 1rem;}
    aside.sidebar{width:300px; min-width:220px;}
    .card{background:var(--card); border-radius:8px; box-shadow:0 6px 18px rgba(20,20,40,0.05); padding:1rem;}
    .sidebar .card{padding:0; overflow:auto; max-height:75vh;}
    .sidebar nav a{display:block; padding:0.8rem 1rem; color:var(--primary); text-decoration:none; border-bottom:1px solid rgba(0,0,0,0.04);}
    .sidebar nav a.active{background:linear-gradient(90deg, rgba(52,152,219,0.08), rgba(52,152,219,0.03)); font-weight:600; border-left:4px solid var(--accent);}
    main.content{flex:1; min-width:0;}
    main .card{padding:1.5rem;}
    .meta{color:var(--muted); font-size:0.95rem; margin-bottom:0.75rem;}
    .loading{color:var(--muted);}
    .toc{margin-top:1rem; font-size:0.95rem;}
    .toc h4{margin:0 0 0.5rem 0;}
    .searchbox{display:flex; gap:0.5rem; padding:0.8rem;}
    .searchbox input{flex:1; padding:0.6rem; border-radius:6px; border:1px solid #e6e9ee;}
    .btn{background:var(--accent); color:white; padding:0.5rem 0.9rem; border-radius:6px; text-decoration:none;}
    footer{max-width:1150px; margin:1.5rem auto; padding:0 1rem; color:var(--muted); font-size:0.9rem;}
    /* responsive */
    @media (max-width:880px){
      .container{flex-direction:column;}
      aside.sidebar{width:100%;}
    }
    /* Markdown content minor tweaks */
    .card h1, .card h2, .card h3{color:var(--primary); margin-top:1rem;}
    .card pre{background:#0b1220; color:#e6eef8; padding:1rem; border-radius:6px; overflow:auto;}
    .card code{background:#f4f6f8; padding:2px 6px; border-radius:4px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;}
    .card img{max-width:100%;}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px;">
      <h1>SchulSystem – Wiki</h1>
      <span style="color:#dbe9ff;font-size:0.95rem">Dokumentation & Anleitung</span>
    </div>
    <div>
      <a class="btn" href="index.html">Zur Startseite</a>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="card">
        <div style="padding:0.8rem;">
          <div class="searchbox">
            <input id="wiki-search" placeholder="Suche Seiten (Live)..." aria-label="Wiki Suche">
            <a id="refresh-btn" class="btn" href="#" title="Neu laden">Neu</a>
          </div>
        </div>
        <nav id="pages-list" aria-label="Wiki Seiten" style="padding-bottom:1rem;"></nav>
      </div>
    </aside>

    <main class="content">
      <div class="card" id="content-card">
        <div id="page-meta" class="meta"></div>
        <div id="page-content" class="loading">Lade Wiki-Startseite...</div>
      </div>
    </main>
  </div>

  <footer>© 2025 SchulSystem · <a href="kontakt.html">Kontakt</a> · <a href="faq.html">FAQ</a></footer>

  <!-- marked.js for markdown -> html -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // Konfiguration: GitHub Wiki raw base URL
    const USER = 'Lukas1120987';
    const REPO = 'Schul-System';
    const RAW_BASE = `https://raw.githubusercontent.com/wiki/${USER}/${REPO}/`;

    // Startseite deines Wikis (Dateiname, typischerweise "Home.md")
    const START_PAGE = 'Home.md';

    // UI Elemente
    const pagesListEl = document.getElementById('pages-list');
    const pageContentEl = document.getElementById('page-content');
    const pageMetaEl = document.getElementById('page-meta');
    const searchInput = document.getElementById('wiki-search');
    const refreshBtn = document.getElementById('refresh-btn');

    // cached pages: {slug: {title, md, html}}
    const pagesCache = {};

    // initial load: fetch start page, parse internal links to build nav
    async function initWiki() {
      try {
        const homeMd = await fetchRaw(START_PAGE);
        if (!homeMd) {
          pageContentEl.innerHTML = '<p class="loading">Die Startseite des Wikis konnte nicht geladen werden.</p>';
          return;
        }
        // render home page
        await renderPageFromMd(START_PAGE, homeMd);

        // find internal links like [Admin-Modul](Admin-Modul) or [Dashboard](Dashboard)
        const internalLinks = extractLocalLinks(homeMd);
        // dedupe and ensure START_PAGE included
        const unique = Array.from(new Set([START_PAGE, ...internalLinks.map(l => normalizeFilename(l))]));
        // populate sidebar with links
        await buildSidebar(unique);

      } catch (err) {
        console.error(err);
        pageContentEl.innerHTML = '<p class="loading">Fehler beim Initialisieren des Wikis.</p>';
      }
    }

    // fetch raw markdown file from github wiki raw url
    async function fetchRaw(filename) {
      const url = RAW_BASE + filename;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.warn('Fehler beim Laden', url, res.status);
          return null;
        }
        const txt = await res.text();
        return txt;
      } catch (e) {
        console.error('Fetch error', e);
        return null;
      }
    }

    // Normalize page references to .md filenames
    function normalizeFilename(name) {
      // If already ends with .md, keep; else append .md
      if (!name) return name;
      // Replace spaces with '-' to match GitHub wiki filenames if needed
      const base = name.trim();
      return base.endsWith('.md') ? base : (encodeURIComponent(base).replace(/%20/g, '-').replace(/\+/g,'-') + '.md');
    }

    // Extract local (wiki-internal) markdown links from md text
    function extractLocalLinks(md) {
      const links = [];
      const regex = /\[([^\]]+)\]\((?!http)([^)]+)\)/g;
      let m;
      while ((m = regex.exec(md)) !== null) {
        const href = m[2].trim();
        if (href && !href.startsWith('#')) links.push(href);
      }
      return links;
    }

    // Build sidebar and prefetch pages
    async function buildSidebar(filenames) {
      pagesListEl.innerHTML = '<div style="padding:0.6rem 1rem;color:var(--muted)">Seiten laden…</div>';
      const items = [];
      for (const fnameRaw of filenames) {
        const fname = typeof fnameRaw === 'string' ? fnameRaw : fnameRaw.name;
        const mdName = fname.endsWith('.md') ? fname : normalizeFilename(fname);
        // Try multiple decoding attempts to find a working file:
        let mdText = await fetchRaw(mdName);
        if (!mdText) {
          // also try raw page title unescaped
          const tryName2 = fname.replace(/-/g,' ');
          mdText = await fetchRaw(tryName2.endsWith('.md') ? tryName2 : (tryName2 + '.md'));
        }
        const title = (mdText ? (mdText.split('\\n')[0].replace(/^#\s*/,'').trim()) : (mdName.replace('.md','')));
        items.push({mdName, title, md: mdText});
        // cache
        pagesCache[mdName] = {title, md: mdText || ''};
      }

      // render nav
      pagesListEl.innerHTML = '';
      items.forEach(item => {
        const a = document.createElement('a');
        a.href = '#';
        a.dataset.page = item.mdName;
        a.innerText = item.title || item.mdName.replace('.md','');
        a.addEventListener('click', async (e) => {
          e.preventDefault();
          setActiveLink(a);
          await openPage(item.mdName);
        });
        pagesListEl.appendChild(a);
      });

      // set first link active (Home)
      const first = pagesListEl.querySelector('a');
      if (first) {
        setActiveLink(first);
      }
    }

    function setActiveLink(aEl) {
      pagesListEl.querySelectorAll('a').forEach(x => x.classList.remove('active'));
      if (aEl) aEl.classList.add('active');
    }

    // Render page from markdown text
    async function renderPageFromMd(filename, mdText) {
      pageMetaEl.innerHTML = '';
      try {
        const html = marked.parse(mdText || '');
        pageContentEl.innerHTML = html;
        // set meta: attempt to find "Veröffentlicht" or similar from md front matter (not present usually)
        pageMetaEl.innerText = `Seite: ${filename.replace('.md','')}`;
      } catch (err) {
        pageContentEl.innerHTML = '<p>Fehler beim Rendern der Seite.</p>';
        console.error(err);
      }
    }

    // Open a page by filename: fetch if not cached
    async function openPage(filename) {
      pageContentEl.innerHTML = '<p class="loading">Lade Seite…</p>';
      let cached = pagesCache[filename];
      if (cached && cached.md) {
        await renderPageFromMd(filename, cached.md);
        return;
      }
      const md = await fetchRaw(filename);
      if (!md) {
        pageContentEl.innerHTML = `<p class="loading">Die Seite "${filename}" konnte nicht gefunden werden.</p>`;
        return;
      }
      pagesCache[filename] = {title: filename.replace('.md',''), md};
      await renderPageFromMd(filename, md);
    }

    // Search: simple client-side filter for sidebar
    searchInput.addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      pagesListEl.querySelectorAll('a').forEach(a => {
        const txt = a.innerText.toLowerCase();
        a.style.display = txt.includes(q) ? 'block' : 'none';
      });
    });

    refreshBtn.addEventListener('click', function(e){
      e.preventDefault();
      pagesListEl.innerHTML = '<div style="padding:0.6rem 1rem;color:var(--muted)">Neu laden…</div>';
      // re-init
      initWiki();
    });

    // Initialize on load
    initWiki();

  </script>
</body>
</html>
